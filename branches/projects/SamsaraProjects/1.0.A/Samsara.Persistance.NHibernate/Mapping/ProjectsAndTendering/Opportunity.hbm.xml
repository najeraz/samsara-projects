<?xml version="1.0" encoding="utf-8" ?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" 
  assembly="Samsara.ProjectsAndTendering.Core" 
  namespace="Samsara.ProjectsAndTendering.Core.Entities">
  
  <class name="Opportunity" table="ProjectsAndTendering.Opportunities">
    
    <id name="OpportunityId" type="int">
      <generator class="native"/>
    </id>
    
    <property name="AcquisitionReason"/>
    <property name="RegistrationDate"/>
    <property name="Name"/>
    <property name="IsLOR"/>
    <property name="ClarificationDate"/>
    <property name="PreRevisionDate"/>
    <property name="Deadline"/>

    <property name="UpdatedBy"/>
    <property name="CreatedBy"/>
    <property name="CreatedOn" type="Timestamp"/>
    <property name="UpdatedOn" type="Timestamp"/>
    <property name="Activated"/>
    <property name="Deleted"/>
    
    <many-to-one name="Organization"
                 class="Samsara.ProjectsAndTendering.Core.Entities.Organization, Samsara.ProjectsAndTendering.Core"
                 column="OrganizationId"/>
    <many-to-one name="Bidder"
                 class="Samsara.ProjectsAndTendering.Core.Entities.Bidder, Samsara.ProjectsAndTendering.Core"
                 column="BidderId"/>
    <many-to-one name="Dependency"
                 class="Samsara.ProjectsAndTendering.Core.Entities.Dependency, Samsara.ProjectsAndTendering.Core"
                 column="DependencyId"/>
    <many-to-one name="EndUser"
                 class="Samsara.ProjectsAndTendering.Core.Entities.EndUser, Samsara.ProjectsAndTendering.Core"
                 column="EndUserId"/>
    <many-to-one name="Asesor"
                 class="Samsara.ProjectsAndTendering.Core.Entities.Asesor, Samsara.ProjectsAndTendering.Core"
                 column="AsesorId"/>
    <many-to-one name="OpportunityStatus"
                 class="Samsara.ProjectsAndTendering.Core.Entities.OpportunityStatus, Samsara.ProjectsAndTendering.Core"
                 column="OpportunityStatusId"/>
    <many-to-one name="OpportunityType"
                 class="Samsara.ProjectsAndTendering.Core.Entities.OpportunityType, Samsara.ProjectsAndTendering.Core"
                 column="OpportunityTypeId"/>
    
    <set name="OpportunityLogs" table="ProjectsAndTendering.OpportunityLogs" where="Deleted = 0 AND Activated = 1"
         cascade="all-delete-orphan" lazy="false">
      <key column="OpportunityId"/>
      <one-to-many
        class="Samsara.ProjectsAndTendering.Core.Entities.OpportunityLog, Samsara.ProjectsAndTendering.Core"/>
    </set>
    
  </class>

  <query name="Opportunity.GetListByParameters">
    <![CDATA[
        from Opportunity where Deleted = 0 and Activated = 1
    ]]>
  </query>

  <sql-query name="Opportunity.SearchByParameters" cacheable="false" read-only="true">
    <return-scalar column="OpportunityId" type="int"/>
    <return-scalar column="OpportunityName" type="string"/>
    <return-scalar column="OpportunityTypeName" type="string"/>
    <return-scalar column="OrganizationName" type="string"/>
    <return-scalar column="BidderName" type="string"/>
    <return-scalar column="DependencyName" type="string"/>
    <return-scalar column="EndUserName" type="string"/>
    <return-scalar column="RegistrationDate" type="DateTime"/>
    <return-scalar column="AsesorName" type="string"/>
    <return-scalar column="PreRevisionDate" type="DateTime"/>
    <return-scalar column="Deadline" type="DateTime"/>
    <return-scalar column="OpportunityStatusName" type="string"/>
    <![CDATA[
      SELECT o.OpportunityId, o.Name OpportunityName, ot.Name OpportunityTypeName, 
      org.Name OrganizationName, b.Name BidderName, d.Name DependencyName, eu.Name EndUserName,
      o.RegistrationDate, a.Name AsesorName, o.PreRevisionDate, o.Deadline, os.Name OpportunityStatusName
      FROM ProjectsAndTendering.Opportunities o
      INNER JOIN  ProjectsAndTendering.OpportunityTypes ot      ON ot.OpportunityTypeId = o.OpportunityTypeId AND ot.Deleted = 0 and ot.Activated = 1
      LEFT JOIN   ProjectsAndTendering.Organizations org        ON org.OrganizationId = o.OrganizationId AND org.Deleted = 0 and org.Activated = 1
      LEFT JOIN   ProjectsAndTendering.Bidders b	     	      	ON b.BidderId = o.BidderId AND b.Deleted = 0 and b.Activated = 1
      LEFT JOIN   ProjectsAndTendering.Dependencies d	      	  ON d.DependencyId = o.DependencyId AND d.Deleted = 0 and d.Activated = 1
      LEFT JOIN   ProjectsAndTendering.EndUsers eu	    	      ON eu.EndUserId = o.EndUserId AND eu.Deleted = 0 and eu.Activated = 1
      LEFT JOIN   ProjectsAndTendering.Asesors a		    	      ON a.AsesorId = o.AsesorId AND a.Deleted = 0 and a.Activated = 1
      LEFT JOIN   ProjectsAndTendering.OpportunityStatuses os	  ON os.OpportunityStatusId = o.OpportunityStatusId AND os.Deleted = 0 and os.Activated = 1
      WHERE o.Deleted = 0 and o.Activated = 1
      AND o.Name like :Name
      AND (o.OpportunityTypeId = :OpportunityTypeId OR :OpportunityTypeId = -1)
      AND (o.OrganizationId = :OrganizationId OR :OrganizationId = -1)
      AND (o.BidderId = :BidderId OR :BidderId = -1)
      AND (o.DependencyId = :DependencyId OR :DependencyId = -1)
      AND (o.EndUserId = :EndUserId OR :EndUserId = -1)
      AND (o.AsesorId = :AsesorId OR :AsesorId = -1)
      AND (o.OpportunityStatusId = :OpportunityStatusId OR :OpportunityStatusId = -1)
      AND (:DateTypeSearchId = 1 and :MinDate <= o.RegistrationDate and :MaxDate >= o.RegistrationDate
        OR :DateTypeSearchId = 2 and :MinDate <= o.Deadline and :MaxDate >= o.Deadline
        OR :DateTypeSearchId = 4 and :MinDate <= o.ClarificationDate and :MaxDate >= o.ClarificationDate
        OR :DateTypeSearchId = 5 and :MinDate <= o.PreRevisionDate and :MaxDate >= o.PreRevisionDate
        OR :DateTypeSearchId = -1)
      AND (:OnlyNotRelatedToTenders = 0 OR o.OpportunityId NOT IN (SELECT OpportunityId FROM ProjectsAndTendering.Tenders))
    ]]>
  </sql-query>

</hibernate-mapping>