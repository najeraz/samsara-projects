<?xml version="1.0" encoding="utf-8" ?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" 
  assembly="Samsara.ProjectsAndTendering.Core" 
  namespace="Samsara.ProjectsAndTendering.Core.Entities.Domain">
  
  <class name="Tender" table="Tenders">
    
    <id name="TenderId" type="int">
      <generator class="native"/>
    </id>

    <property name="RegistrationDate"/>
    <property name="BidderId"/>
    <property name="DependencyId"/>
    <property name="Name"/>
    <property name="AsesorId"/>
    <property name="ClarificationDate"/>
    <property name="Deadline"/>
    <property name="PricingStrategy"/>
    <property name="Results"/>
    <property name="VerdictDate"/>
    <property name="FolioReference"/>
    <property name="ManufacturerId"/>
    <property name="TenderStatusId"/>
    <property name="ApprovedBy"/>
    <property name="ManufacturerSupport"/>
    <property name="PreviousTenderId"/>
    <property name="Deleted"/>
    <property name="Activated"/>

  </class>

  <query name="LoadTenders">
    <![CDATA[
        from Tender where Deleted = 0 and Activated = 1
    ]]>
  </query>

  <sql-query name="SearchTenders" cacheable="false" read-only="true">
    <return-scalar column="TenderId" type="int"/>
    <return-scalar column="RegistrationDate" type="DateTime"/>
    <return-scalar column="DependencyName" type="string"/>
    <return-scalar column="AsesorName" type="string"/>
    <return-scalar column="ClarificationDate" type="DateTime"/>
    <return-scalar column="PreRevisionDate" type="DateTime"/>
    <return-scalar column="Deadline" type="DateTime"/>
    <return-scalar column="VerdictDate" type="DateTime"/>
    <return-scalar column="FolioReference" type="string"/>
    <return-scalar column="ManufacturerName" type="string"/>
    <return-scalar column="TenderStatusName" type="string"/>
    <return-scalar column="ApproverName" type="string"/>
    <return-scalar column="PreviousTenderName" type="string"/>
    <![CDATA[
      SELECT t.TenderId, t.RegistrationDate, b.Name BidderName, t.Name TenderName,
      d.Name DependencyName, a.Name AsesorName, t.ClarificationDate, t.PreRevisionDate,
      t.Deadline, t.VerdictDate, t.FolioReference, m.Name ManufacturerName, 
      ts.Name TenderStatusName, ap.Name ApproverName, pt.Name PreviousTenderName
      FROM Tenders t
      INNER JOIN	Bidders b	  		ON b.BidderId = t.BidderId AND b.Deleted = 0 and b.Activated = 1
      LEFT JOIN	Asesors a		    	ON a.AsesorId = t.AsesorId AND a.Deleted = 0 and a.Activated = 1
      LEFT JOIN	Dependencies d		ON d.DependencyId = t.DependencyId AND d.Deleted = 0 and d.Activated = 1
      LEFT JOIN	TenderStatuses ts	ON ts.TenderStatusId = t.TenderStatusId AND ts.Deleted = 0 and ts.Activated = 1
      LEFT JOIN	Manufacturers m		ON m.ManufacturerId = t.ManufacturerId AND m.Deleted = 0 and m.Activated = 1
      LEFT JOIN	Asesors ap		  	ON ap.AsesorId = t.ApprovedBy AND ap.Deleted = 0 and ap.Activated = 1
      LEFT JOIN	Tenders pt	  		ON pt.TenderId = t.ApprovedBy AND pt.Deleted = 0 and pt.Activated = 1
      WHERE t.Deleted = 0 and t.Activated = 1
      AND (AsesorId = :AsesorId OR :AsesorId = -1)
      AND (BidderId = :BidderId OR :BidderId = -1)
      AND (DependencyId = :DependencyId OR :DependencyId = -1)
      AND (TenderStatusId = :TenderStatusId OR :TenderStatusId = -1)
      AND (:DateTypeSearchId = 1 and :MinDate >= RegistrationDate and :MaxDate <= RegistrationDate
        OR :DateTypeSearchId = 2 and :MinDate >= Deadline and :MaxDate <= Deadline
        OR :DateTypeSearchId = 3 and :MinDate >= VerdictDate and :MaxDate <= VerdictDate
        OR :DateTypeSearchId = 4 and :MinDate >= ClarificationDate and :MaxDate <= ClarificationDate
        OR :DateTypeSearchId = 5 and :MinDate >= PreRevisionDate and :MaxDate <= PreRevisionDate
        OR :DateTypeSearchId = -1)
    ]]>
  </sql-query>

</hibernate-mapping>